name: Build Kernel IES (Fix VDSO Assembler)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel starlte
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        repository: krazey/android_kernel_samsung_exynos9810
        path: kernel_source
        fetch-depth: 1

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison flex libssl-dev make gcc python3 git zip lz4 cpio \
          clang-14 lld-14 gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi

    - name: Setup KernelSU
      run: |
        cd kernel_source
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Build Kernel
      run: |
        cd kernel_source
        mkdir -p out

        # FIX KRUSIAL: 
        # 1. Tambahkan CROSS_COMPILE_ARM32 agar vdso32 tidak error
        # 2. Tambahkan parameter AS agar Clang tidak salah panggil assembler
        
        args="O=out \
              ARCH=arm64 \
              CC=clang-14 \
              CLANG_TRIPLE=aarch64-linux-gnu- \
              CROSS_COMPILE=aarch64-linux-gnu- \
              CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
              AS=aarch64-linux-gnu-as \
              LLVM_IAS=0"

        # Cari config
        CONFIG_FILE=$(find arch/arm64/configs/ -name "*starlte*defconfig" | head -n 1 | xargs basename)
        make $args $CONFIG_FILE

        # Injeksi KSU & Matikan LTO
        echo "CONFIG_KSU=y" >> out/.config
        echo "CONFIG_KPROBES=y" >> out/.config
        echo "CONFIG_LTO_CLANG=n" >> out/.config
        echo "CONFIG_LTO=n" >> out/.config
        
        make $args olddefconfig

        # Mulai Build
        make -j$(nproc) $args

    - name: Pack Result
      run: |
        mkdir -p final_out
        if [ -f kernel_source/out/arch/arm64/boot/Image.gz ]; then
          cp kernel_source/out/arch/arm64/boot/Image.gz final_out/
          find kernel_source/out/arch/arm64/boot/dts/ -name "*.dtb" -exec cp {} final_out/ \;
          cd final_out
          cat Image.gz *.dtb > Image.gz-dtb
        else
          echo "Kernel image not found!"
          exit 1
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IES-Kernel-starlte-Fixed
        path: final_out/Image.gz-dtb
        
