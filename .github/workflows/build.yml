name: LineageOS Kernel Build + KernelSU

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel LineageOS
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        repository: LineageOS/android_kernel_samsung_exynos9810
        # Menggunakan branch default (biasanya lineage-19.1 atau yang aktif)
        path: kernel_source

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison flex libssl-dev make gcc python3 git zip lz4 cpio \
          lld clang llvm binutils-aarch64-linux-gnu

    - name: Install KernelSU (Standard/Old Method)
      run: |
        cd kernel_source
        # Menggunakan script installer resmi (selalu bekerja untuk Kernel 4.9 non-GKI)
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
        echo "KernelSU berhasil dipasang!"

    - name: Build Kernel
      run: |
        cd kernel_source
        mkdir -p out

        # Setup Environment Variables (Clang dari Repo Ubuntu sudah cukup stabil untuk LineageOS)
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=clang
        export LD=ld.lld
        export CLANG_TRIPLE=aarch64-linux-gnu-

        # 1. Load Defconfig
        # LineageOS biasanya pakai nama 'lineageos_starlte_defconfig' atau 'exynos9810_defconfig'
        # Kita coba cari file config yang ada unsur 'starlte' nya
        CONFIG_NAME=$(find arch/arm64/configs -name "*starlte*defconfig" | head -n 1 | xargs basename)
        
        if [ -z "$CONFIG_NAME" ]; then
            # Fallback jika tidak ketemu, pakai exynos9810_defconfig
            CONFIG_NAME="exynos9810_defconfig"
        fi
        
        echo "Menggunakan config: $CONFIG_NAME"
        make O=out $CONFIG_NAME

        # 2. Aktifkan KernelSU di Config
        # Kita manipulasi file .config langsung untuk memastikan KSU aktif
        echo "Mengaktifkan KernelSU..."
        echo "CONFIG_KSU=y" >> out/.config
        echo "CONFIG_KPROBES=y" >> out/.config
        echo "CONFIG_HAVE_KPROBES=y" >> out/.config
        echo "CONFIG_KPROBES_ON_FTRACE=y" >> out/.config

        # 3. Olddefconfig (Penyelamat)
        # Biar fitur KSU dan fitur lain ter-set otomatis tanpa nanya-nanya
        make O=out olddefconfig

        # 4. Compile
        make -j$(nproc) O=out \
             CC=clang \
             CLANG_TRIPLE=aarch64-linux-gnu- \
             CROSS_COMPILE=aarch64-linux-gnu- \
             LD=ld.lld

    - name: Pack Image
      run: |
        cd kernel_source
        mkdir -p ../final_out
        
        if [ -f out/arch/arm64/boot/Image.gz ]; then
          cp out/arch/arm64/boot/Image.gz ../final_out/
          # Copy DTB juga
          find out/arch/arm64/boot/dts/ -name "*.dtb" -exec cp {} ../final_out/ \;
          
          # Gabung Image.gz + DTB (Format Samsung)
          cd ../final_out
          cat Image.gz *.dtb > Image.gz-dtb
          echo "Build Selesai!"
        else
          echo "Gawat! Image.gz tidak terbentuk. Cek log error di atas."
          exit 1
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kernel-lineage-ksu
        path: final_out/Image.gz-dtb
        
