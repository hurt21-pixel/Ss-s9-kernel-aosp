name: LineageOS Kernel Build + KernelSU

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel starlte
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        repository: LineageOS/android_kernel_samsung_exynos9810
        path: kernel_source
        fetch-depth: 1

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison flex libssl-dev make gcc python3 git zip lz4 cpio \
          lld clang llvm binutils-aarch64-linux-gnu

    - name: Setup KernelSU (Official Method)
      run: |
        cd kernel_source
        # Menjalankan script installer resmi KernelSU
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
        echo "KernelSU integrated successfully."

    - name: Build Kernel
      run: |
        cd kernel_source
        mkdir -p out

        # 1. Tentukan Toolchain & Matikan Integrated Assembler (Fix Error gettimeofday.S)
        # Kita pakai LLVM_IAS=0 agar file .S diproses oleh GNU Assembler (binutils)
        args="O=out \
              ARCH=arm64 \
              CC=clang \
              LD=ld.lld \
              AR=llvm-ar \
              NM=llvm-nm \
              OBJCOPY=llvm-objcopy \
              OBJDUMP=llvm-objdump \
              STRIP=llvm-strip \
              CLANG_TRIPLE=aarch64-linux-gnu- \
              CROSS_COMPILE=aarch64-linux-gnu- \
              LLVM=1 \
              LLVM_IAS=0"

        # 2. Ambil Config (Gunakan starlte_defconfig)
        make $args starlte_defconfig

        # 3. Aktifkan KernelSU secara paksa di .config
        echo "CONFIG_KSU=y" >> out/.config
        echo "CONFIG_KPROBES=y" >> out/.config
        echo "CONFIG_HAVE_KPROBES=y" >> out/.config
        echo "CONFIG_KPROBES_ON_FTRACE=y" >> out/.config

        # 4. FIX: Set semua opsi baru (CPU MASK dll) ke default agar tidak 'Aborted'
        make $args olddefconfig

        # 5. Mulai Compiling
        make -j$(nproc) $args

    - name: Pack Output
      run: |
        mkdir -p final_out
        # Cari Image.gz
        if [ -f kernel_source/out/arch/arm64/boot/Image.gz ]; then
          cp kernel_source/out/arch/arm64/boot/Image.gz final_out/
          # Ambil semua DTB yang dihasilkan
          find kernel_source/out/arch/arm64/boot/dts/ -name "*.dtb" -exec cp {} final_out/ \;
          cd final_out
          # Gabungkan Image.gz dan DTB (Format kernel Samsung)
          cat Image.gz *.dtb > Image.gz-dtb
          echo "Build Success!"
        else
          echo "Error: Image.gz not found! Check the build logs above."
          exit 1
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LineageOS-Kernel-KSU-starlte
        path: final_out/Image.gz-dtb
        
